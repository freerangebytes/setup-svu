---
name: Versioning

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  calculateVersion:
    name: Calculate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      current: ${{ steps.version.outputs.current }}
      skip: ${{ steps.version.outputs.skip }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install svu
        uses: ./

      - name: Calculate next version
        id: version
        run: |
          CURRENT=$(svu current || echo "v0.0.0")
          NEXT=$(svu next)

          echo "Current: $CURRENT"
          echo "Next: $NEXT"
          echo "current=$CURRENT" >> "$GITHUB_OUTPUT"

          if [ "$CURRENT" = "$NEXT" ]; then
            echo "No version bump needed"
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "version=$NEXT" >> "$GITHUB_OUTPUT"
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

  tag:
    name: Create Tag and Release
    runs-on: ubuntu-latest
    needs: calculateVersion
    if: needs.calculateVersion.outputs.skip != 'true'
    permissions:
      contents: write
    steps:
      - name: Create Tag
        uses: actions/github-script@v8
        env:
          VERSION: ${{ needs.calculateVersion.outputs.version }}
        with:
          script: |
            const version = process.env['VERSION'];
            core.info(`Creating tag: ${version}`);

            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/tags/${version}`,
              sha: context.sha
            });

      - name: Create Release
        uses: actions/github-script@v8
        env:
          VERSION: ${{ needs.calculateVersion.outputs.version }}
        with:
          script: |
            const version = process.env['VERSION'];
            core.info(`Creating release: ${version}`);

            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: version,
              name: version,
              generate_release_notes: true
            });

  summary:
    name: Write summary
    runs-on: ubuntu-latest
    needs: [calculateVersion, tag]
    steps:
      - name: Write summary
        env:
          CURRENT: ${{ needs.calculateVersion.outputs.current }}
          VERSION: ${{ needs.calculateVersion.outputs.version }}
        run: |
          {
            echo "## Release Summary"
            echo ""
            echo "**Previous version:** $CURRENT"
            echo "**New version:** $VERSION"
          } >> "$GITHUB_STEP_SUMMARY"

  no-release:
    name: No Release
    runs-on: ubuntu-latest
    needs: calculateVersion
    if: needs.calculateVersion.outputs.skip == 'true'
    steps:
      - name: Write summary
        run: |
          {
            echo "## No Release"
            echo ""
            echo "No version bump triggered. Use conventional commits:"
            echo "- \`fix:\` → patch"
            echo "- \`feat:\` → minor"
            echo "- \`feat!:\` or \`BREAKING CHANGE:\` → major"
          } >> "$GITHUB_STEP_SUMMARY"
